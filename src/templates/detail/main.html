{% include "_macros/emaillink.html" %}
{% include "_macros/app_tile.html" %}
{% include "_macros/rating.html" %}
{% include "_macros/stars.html" %}

{% set endpoint = api('app', [slug]) %}

<section class="main">
  <div class="subheader">
    <h1>&nbsp;</h1>
  </div>
</section>

<div class="detail" itemscope itemtype="http://schema.org/SoftwareApplication"
     data-slug="{{ slug }}">
<section class="main full app-header expanded">
  {% defer (url=endpoint, as='app', key=slug, id='app-data') %}
    {{ app_tile(this, is_detail=True, tray=True, src='detail') }}
    <section id="installed">
      <p class="installed">
        {{ _('Installed!') }}
      </p>
      <p class="how mac">
        {{ _('Launch this app from your <b>Applications</b> directory.') }}
      </p>
      <p class="how windows">
        {{ _('Launch this app from your <b>Windows desktop</b> or <b>Start &#9658; All Programs</b>.') }}
      </p>
      <p class="how linux">
        {{ _('Launch this app from your <b>dash</b>, <b>Application picker</b>, or <b>Applications menu</b>.') }}
      </p>
    </section>
    <div id="purchased-message"></div>
  {% placeholder %}
    <div class="product mkt-tile">
      <img class="icon deferred" src="{{ PLACEHOLDER_ICON }}" alt=""
           data-src="{{ app.icons['64'] }}" height="64" width="64" itemprop="image">
      <div class="info">
        <h3>{{ _('Loading...') }}</h3>
        <div class="price vital">{{ _('Loading...') }}</div>
        <div class="rating vital unrated">
          {{ stars(0) }}
        </div>
      </div>
    <div class="tray previews full"></div>
  {% except %}
    <div class="detailed-error">
      <h2>{{ _('Oh no!') }}</h2>
      {% if error == 403 %}
        <p>{{ _('The app requested is not public.') }}</p>
      {% elif error == 404 %}
        <p>{{ _('The app requested was not found.') }}</p>
      {% elif error == 451 %}
        <p>{{ _('The app requested is not available for your region.') }}</p>
        <p>{{ _('You may wish to contact the developer if you would like to see a version of this app for your region.') }}</p>
      {% else %}
        <p>{{ _('A server error occurred. Please try again later.') }}</p>
      {% endif %}
    </div>
  {% end %}
</section>

{% defer (url=endpoint, as='app', key=slug) %}
  <section class="main full app-info">
    <div class="detail-flex-wrap">
      <div class="detail-left-side">
        {% if this.banner_regions and this.banner_message and
              this.banner_regions.indexOf(user_helpers.region()) != -1 %}
          <section class="region-banner">
            <div>{{ this.banner_message|translate(this)|safe }}</div>
          </section>
        {% endif %}

        <section class="prose">
          <div>
            <h3>{{ _('Description') }}</h3>
            <div class="description-wrapper truncated-wrapper truncated">
              <p class="description" itemprop="description">
                {{ this.description|translate(this)|nl2br }}
              </p>
            </div>
            <a href="#" class="truncate-toggle view-all-tab">{{ _('View All') }}</a>
          </div>
        </section>
      </div>

      <div class="detail-right-side">
        {% if this.release_notes %}
          <section class="prose release-notes">
            <div>
              <h3>{{ _('Updates') }}</h3>
              <div class="truncated-wrapper truncated">
                <p>{{ this.release_notes|translate(this)|nl2br }}</p>
              </div>
              <a href="#" class="truncate-toggle view-all-tab">{{ _('View All') }}</a>
            </div>
          </section>
        {% endif %}

        {% if this.is_packaged %}
          <section class="prose package-version">
            <h3>{{ _('Version') }}</h3>
            <p>{{ _('Latest version: {version}',
                    version=this.current_version) }}</p>
          </section>
        {% endif %}

        <section class="app-support">
          <ul>
            {% if this.support_email %}
              <li class="support-email" data-tracking="Support email">
                {{ emaillink(this.support_email, _('Email Support'),
                             class='button') }}
              </li>
            {% endif %}
            {% if this.support_url %}
              <li class="support-url" data-tracking="Support site">
                <a class="button" rel="external" {{ this.support_url|external_href }}>
                  {{ _('Support Site') }}</a>
              </li>
            {% endif %}
            {% if this.homepage %}
              <li class="homepage" data-tracking="Homepage">
                <a class="button" rel="external" {{ this.homepage|external_href }}>
                  {{ _('Homepage') }}</a>
              </li>
            {% endif %}
            {% if this.privacy_policy %}
              <li class="privacy-policy" data-tracking="Privacy policy">
                <a class="button" href="{{ url('app/privacy', [slug]) }}">
                  {{ _('Privacy Policy') }}</a>
              </li>
            {% endif %}
            {% if this.public_stats or user.has_developed(this.id) %}
              <li class="statistics" data-tracking="Statistics">
                <a class="button view-stats" rel="external" href="/statistics/app/{{ slug }}">
                  {{ _('Statistics') }}</a>
              </li>
            {% endif %}
            {% if user.has_developed(this.id) or user.get_permission('reviewer') %}
              <li>
                <a class="button action manage" href="/developers/app/{{ slug }}/edit"
                   rel="external">
                  {{ _('Edit Listing') }}
                </a>
              </li>
            {% endif %}
            {% if user.get_permission('reviewer') %}
              <li>
                <a class="button action reviewer" href="/reviewers/app/{{ slug }}"
                   rel="external">
                  {{ _('Approve / Reject') if this.status == 2 or this.status == 13 else
                     _('Review History') }}
                </a>
              </li>
            {% endif %}
          </ul>
        </section>
      </div>
    </div>
  </section>
{% except %}
{% end %}

<!--Reviews (detail/reviews.styl).-->
<section class="main full app-reviews">
  {% defer (url=apiParams('reviews', {'app': slug}), id='ratings') %}
    <div class="detail-flex-wrap">
      <div class="detail-left-side">
        <h3>{{ _('Reviews') }}</h3>

        {% if this.meta.total_count %}
          <div class="reviews-summary-large">
            {{ stars(this.info.average, detailpage=true) }}
            <p>
              {{ _plural(
                     '1 Review',
                     format(_('{numReviews} Reviews'),
                            numReviews=numberfmt(this.meta.total_count)),
                 n=this.meta.total_count) }}
            </p>
          </div>
        {% endif %}

        {% if this.meta.total_count %}
          <ul class="reviews-wrapper">
            {% for review in this.objects.slice(0, 6) %}
              {{ rating(review, detailpage=true, current_version=this.info.current_version) }}
            {% endfor %}
          </ul>
        {% else %}
          <p class="not-rated">{{ _('App not yet reviewed') }}</p>
        {% endif %}
     </div>

     <div class="detail-right-side">
        {% if this.user.can_rate or not user.logged_in() or this.user.has_rated %}
          <section class="review-buttons">
            <ul>
              {% if user.logged_in() and this.user.has_rated %}
                <li>
                  <a id="edit-review" class="button" data-app="{{ slug }}"
                     href="{{ url('app/ratings/edit', [slug]) }}">
                    {{ _('Edit your review') }}
                  </a>
                </li>
              {% else %}
                <li>
                  <a id="add-review" class="button" data-app="{{ slug }}"
                     href="{{ url('app/ratings/add', [slug]) }}">
                     {{ _('Leave a review') if user.logged_in() else _('Sign in to review') }}
                  </a>
                </li>
              {% endif %}
              <li>
                <a id="edit-review" class="button" data-app="{{ slug }}"
                   href="{{ url('app/ratings', [slug]) }}">
                  {{ _('Read all reviews') }}
                </a>
              </li>
            </ul>
          </section>
        {% endif %}
      </div>
    </div>
  {% placeholder %}
    <p class="spinner alt padded"></p>
  {% except %}
  {% end %}
</section>

{% defer (url=endpoint, as='app', key=slug) %}
  {% if settings.payments_enabled and settings.upsell_enabled and this.upsell %}
    <section class="main upsell-wrapper c">
      <div>
        <a class="upsell" href="{{ url('app', [this.upsell.app_slug])|urlparams(src='mkt-detail-upsell') }}">
          <img class="icon" src="{{ this.upsell.icon_url }}">
          <div>
            <span class="avail">{{ _('Premium version available') }}</span>
            <span class="name">{{ this.upsell.name }}</span>
          </div>
        </a>
      </div>
    </section>
  {% endif %}
{% except %}
{% end %}

{% include "detail/content_ratings.html" %}

<section class="main full">
  <a class="button support" href="{{ url('app/abuse', [slug]) }}">
    {{ _('Report Abuse') }}</a>
</section>

</div>
